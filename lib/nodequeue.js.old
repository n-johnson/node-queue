/*!
 * nodeQueue v0.0.1
 * Author: Nathan Johnson <node@njohnson.me>
 * License: MIT Licensed
 *
 * File: nodequeue.js
 */

/*Put this note somewhere better (like documentation once it exists)
 *     ****Note about callbacks*****
 * - When a callback is refered to as function cb(options) it is OPTIONAL
 * - When a callback is refered to as function finalCallBack(options) it is REQUIRED
 */

var Queue = function(port, server) {
	this.Database = require('./lib/database.js').init(port, server); //Initializes the database + expose as child
	this.Job = require('./lib/job.js');//Exposes Job as a child of Queue
};

/**
 * [init - Must be called when class is required]
 * require('nodequeue.js').init(options);
 * @param  {[type]} port   [Redis Server Port]
 * @param  {[type]} server [Redis Server Host]
 * @return {[Queue]}        [Returns/exposes the job Queue to the application]
 */
module.exports.init = function(port, server) {
	return new Queue(port, server);
};

/**
 * [Job - Stores job data | Obj as opposed to hard coded variables allows for easier modification]
 * Accessable as a method of Queue
 * @param {[type]} obj {
 *                 name: "jobIdentifier", [Used in job execution (job "type")]
 *                 status: "[Delayed | Queued | Running | Failed | Complate]",
 *                 payload: "{jobData1:foo, jobData2:bar}", [Format agnostic, 100% controlled by application]
 *                 id: "85", [job:id storage in database] *
 * }
 */
var Job = function(obj) {
	if (obj) {
		this.name = obj.name;
		this.status = obj.status;
		this.payload = obj.payload;
		this.id = obj.id || null;
	} else {
		this.name = null;
	}
};

/**
 * [pushJob - Pushes given job into the queue]
 * @param  {Function} cb(err, res) - Optional
 *  res = job ID
 * @return {[boolean]}
 *         - True = DB call made, no knowledge of success
 *         - False = Job was null, no call made
 */
Job.prototype.pushJob = function(cb) {
	cb = cb || function(err, res) {};
	var that = this;
	if (this.name) {
		Database.incr("id:jobs", function(id) { //Increment redis variable id:jobs
			Database.client.hmset('job:' + id, { //Callback of incr, set the hash of job:incr
				"name": that.name + id,
				"status": that.status,
				"payload": that.payload
			}, function() { //Callback of hmset, add incr to jobs list
				Database.client.rpush('jobs', id, function(err, res) {
					cb(err, res); //Callback
				});
			});
		});
		return true;
	}
	console.log("Invalid data passed to Job");
	cb(null);
	return false;
};


/**
 * [getAllJobs - Pulls all jobs from the Queue in array of type Jobs]
 * @param  {[function]} finalCallBack(jobArray) - Handles data once returned *REQUIRED*
 * If there is an error in getting job ids from redis, callback will return null.
 * @return {[null]}               [Use callback function]
 */
Queue.prototype.getAllJobs = function(finalCallBack) {
	var that = this;
	that.Database.client.lrange('jobs', 0, -1, function(err, data) { //Gets job IDs from jobs list in database
		if (data && !err) {
			var jobIDs = (data + '').split(','); //Simple object -> array
			var blankArray = []; //pass along an initialized array
			console.log(jobIDs);
			that._recursiveJobLookup(jobIDs, blankArray, finalCallBack);
		} else {
			finalCallBack(null); //Something went wrong, send null callback
		}
	});
	return null;
};

/**
 * [_recursiveJobLookup - Grabs first id in jobIDarray, performs data lookup
 *                        and pushes it to jobObjectArray. When jobIDarray is
 *                        empty, finalCallBack(Job[]) will be called.
 * @param  {[type]} jobIDarray     [Contains array of IDs contained in jobs list from db]
 * @param  {[type]} jobObjectArray [Contains array of Job objects as they are created]
 * @param  {[type]} finalCallBack  [ finalCallBack(Job[array]); ]
 * @return {[null]}
 */
Queue.prototype._recursiveJobLookup = function(jobIDarray, jobObjectArray, finalCallBack) {
	var that = this;
	if (jobIDarray.length === 0) { //We're done! Send data back
		return finalCallBack(jobObjectArray);
	}

	var currentID = jobIDarray.shift(); //Removes first element from array and returns it

	that.Database.client.hgetall('job:' + currentID, function(err, obj) {
		if (obj && !err) {
			var jobObj = new that.Job({
				name: obj.name,
				status: obj.status,
				payload: obj.payload,
				id: currentID
			});
			if (jobObj.name) //Make sure it's a valid job before we push it
				jobObjectArray.push(jobObj);
		}

		that._recursiveJobLookup(jobIDarray, jobObjectArray, finalCallBack); //Recursion until array empty
	});
	return null;
};